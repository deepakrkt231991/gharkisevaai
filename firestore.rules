rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- PUBLIC-READABLE COLLECTIONS ---
    // Anyone can read (get/list) these collections.
    // Writes are restricted to authenticated users.

    match /properties/{propertyId} {
      allow read: if true;
      allow write: if request.auth != null;
    }
    
    match /products/{productId} {
      allow read: if true;
      allow write: if request.auth != null;
    }
    
    match /tools/{toolId} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    match /workers/{workerId} {
      allow read: if true;
      // Only the worker can update their own profile.
      allow write: if request.auth != null && request.auth.uid == workerId;
    }
    
    match /banners/{bannerId} {
      allow read: if true;
      allow write: if false; // Admin-only writes
    }
    
    match /app_settings/{docId} {
      allow read: if true;
      allow write: if false; // Admin-only writes
    }

    // --- USER-OWNED DATA ---
    // A user can only access their own documents.

    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    match /health/{healthId} {
       // On create, check the incoming document's userId.
       allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
       // On read/update, check the existing document's userId.
       allow read, update: if request.auth != null && resource.data.userId == request.auth.uid;
    }
    
    match /sos_alerts/{alertId} {
       allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
       allow read, update: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // --- TRANSACTION DATA (MOSTLY IMMUTABLE) ---
    match /transactions/{transactionId} {
      // User can only read their own transactions.
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      // Transactions are created by server-side logic (actions).
      allow create: if request.auth != null;
      // Transactions should never be updated or deleted by clients.
      allow update, delete: if false;
    }

    // --- TWO-PARTY DATA (DEALS, JOBS, etc.) ---
    // Only the two parties involved in the transaction can access these documents.
    
    match /jobs/{jobId} {
      allow create: if request.auth != null && (request.resource.data.customerId == request.auth.uid || request.resource.data.workerId == request.auth.uid);
      allow read, update, delete: if request.auth != null && (resource.data.customerId == request.auth.uid || resource.data.workerId == request.auth.uid);
    }
    
    match /deals/{dealId} {
      allow create: if request.auth != null && (request.resource.data.buyerId == request.auth.uid || request.resource.data.sellerId == request.auth.uid);
      allow read, update, delete: if request.auth != null && (resource.data.buyerId == request.auth.uid || resource.data.sellerId == request.auth.uid);
    }
    
    match /legal_agreements/{agreementId} {
       allow create: if request.auth != null && (request.resource.data.buyerId == request.auth.uid || request.resource.data.sellerId == request.auth.uid);
       allow read, update, delete: if request.auth != null && (resource.data.buyerId == request.auth.uid || resource.data.sellerId == request.auth.uid);
    }
    
    match /rentals/{rentalId} {
       allow create: if request.auth != null && (request.resource.data.renterId == request.auth.uid || request.resource.data.ownerId == request.auth.uid);
       allow read, update, delete: if request.auth != null && (resource.data.renterId == request.auth.uid || resource.data.ownerId == request.auth.uid);
    }
  }
}
